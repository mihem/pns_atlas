---
title: "Reproducing the figures"
format: 
    html:
        embed-resources: true
---

## Load libraries

```{r}
#| output: false
library(Seurat)
library(ggplot2)
library(qs)
library(sessioninfo)
```


## Figure 1

Download and read the data.
```{r}
options(timeout = 3600)
if (!file.exists("umap_figure.qs")) {
    download.file(
        "https://zenodo.org/records/14226219/files/umap_figure.qs?download=1",
        "umap_figure.qs"
    )
}
umap_figure <- qread("umap_figure.qs")
```

**UMAP of all cells (Figure 1B)**
```{r}
DimPlot(
    umap_figure,
    reduction = "umap.scvi.full",
    pt.size = .1,
    alpha = .1,
    cols = umap_figure@misc$cluster_col,
    label = TRUE,
    raster = FALSE
) +
    NoLegend() +
    theme(
        axis.text = element_blank(),
        axis.ticks = element_blank()
    ) +
    xlab("UMAP_1") +
    ylab("UMAP_2")
```

## Figure 2


Download and read the data.

```{r}
if (!file.exists("ic_figure.qs")) {
    download.file(
        "https://zenodo.org/records/14226219/files/umap_figure.qs?download=1",
        "ic_figure.qs"
    )
}
ic_figure <- qread("ic_figure.qs")
```

**UMAP immune cells (Figure 2A)**

```{r}
DimPlot(
    ic_figure,
    reduction = "umap.rpca",
    pt.size = .1,
    alpha = .3,
    cols = ic_figure@misc$ic_cluster_col,
    label = TRUE,
    raster = FALSE
) +
    theme(
        axis.text = element_blank(),
        axis.ticks = element_blank()
    ) +
    NoLegend() +
    xlab("UMAP1") +
    ylab("UMAP2")
```

**Feature plots immune cells (Figure 2B)**

```{r}
FeaturePlot(
    ic_figure,
    features = c("MS4A7", "CX3CR1", "TREM2", "LYVE1", "FOLR2", "TIMD4"),
    reduction = "umap.rpca",
    pt.size = 0.1,
    raster = FALSE,
    coord.fixed = TRUE,
    cols = c("#F0F0F0", "#CB181D"),
    order = TRUE,
    ncol = 3
) &
    theme(
        axis.text = element_blank(),
        axis.ticks = element_blank()
    ) &
    xlab("UMAP1") &
    ylab("UMAP2")

```

```{r}
if (!file.exists("ic_figure.qs")) {
    download.file(
        "https://zenodo.org/records/14226219/files/umap_figure.qs?download=1",
        "b_plasma_figure.qs"
    )
}
b_plasma_figure <- qread("b_plasma_figure.qs")
```

```{r}
#| fig.height: 2.5
DotPlot(
    b_plasma_figure,
    features = c("IGHM", "IGHD", "IGHG1", "IGHG2", "IGHG3", "IGHG4", "IGHA1", "IGHA2"),
    scale = FALSE
) +
    viridis::scale_color_viridis(option = "viridis") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, face = "italic")) +
    xlab("") +
    ylab("") 
```

## Session info

```{r}
session_info()
```